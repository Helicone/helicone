FROM debian:stable-slim

# Install required tools (curl) and clean up
RUN apt-get update && apt-get install -y \
    curl ca-certificates \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Atlas CLI
RUN curl -sSf https://atlasgo.sh | sh
ENV PATH="/root/bin:/usr/local/bin:${PATH}"

WORKDIR /app

# Copy migration files
COPY ./postgres/migrations /app/postgres/migrations
COPY ./postgres/migrations_without_supabase /app/postgres/migrations_without_supabase
COPY ./clickhouse/migrations /app/clickhouse/migrations

# Use Atlas as entrypoint. The compose file will supply the specific commands.
ENTRYPOINT ["atlas"]
CMD ["version"]