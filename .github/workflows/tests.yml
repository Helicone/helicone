name: e2e tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  db-type-checks:
    name: DB type checks
    runs-on: ubuntu-latest

    steps:
      - uses: supabase/setup-cli@v1.2.0
      - run: supabase init
      - run: supabase db start
      - run: supabase db lint
      - name: Verify generated types match Postgres schema
        run: |
          supabase gen types typescript --local > ./web/supabase/database.types.ts
          if ! git diff --ignore-space-at-eol --exit-code --quiet ./web/supabase/database.types.ts; then
            echo "Detected uncommitted changes after build. See status below:"
            git diff
            exit 1
          fi

          supabase gen types typescript --local > ./worker/supabase/database.types.ts
          if ! git diff --ignore-space-at-eol --exit-code --quiet ./worker/supabase/database.types.ts; then
            echo "Detected uncommitted changes after build. See status below:"
            git diff
            exit 1
          fi
  # TODO SEED DATABASE WITH EXAMPLE USERS AND EXAMPLE PROJECTS
  e2e-test-python-async:
    name: Python Async E2E tests
    runs-on: ubuntu-latest
    services:
      clickhouse:
        image: yandex/clickhouse-server
        ports:
          - 8123:8123
    steps:
      - uses: actions/checkout@v2
      - uses: supabase/setup-cli@v1.2.0
      - run: supabase init
      - run: supabase db start
      - name: Install dependencies
        run: |
          pip install requests pytest
      - run: |
          mkdir -p ~/.helicone
          cd worker
          wrangler dev --local --var WORKER_TYPE:HELICONE_API > ~/.helicone/worker.log 2>&1 &
      - name: Run integration tests
        working-directory: tests
        env:
          # SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          # SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          OPENAI_API_BASE: "http://127.0.0.1:8787/v1"
        run: |
          python python_integration_tests.py

  # TODO Copy the same formula for async typescript and proxy as well
  # NOTE:  wrangler dev --local --var WORKER_TYPE:OPENAI_PROXY > ~/.helicone/worker.log 2>&1 &
