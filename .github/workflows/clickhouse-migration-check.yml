name: ClickHouse Migration Versioning Check

on:
  pull_request:
    paths:
      - 'clickhouse/migrations/**'
  push:
    branches:
      - main
    paths:
      - 'clickhouse/migrations/**'

jobs:
  check-migration-numbers:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Check Migration File Numbers
        run: |
          python - << 'EOF'
          import os
          import re
          import sys

          def extract_number(filename):
              match = re.search(r'schema_(\d+)_', filename)
              return int(match.group(1)) if match else None

          migration_dir = 'clickhouse/migrations'
          files = [f for f in os.listdir(migration_dir) if f.startswith('schema_') and f.endswith('.sql')]
          
          if not files:
              print("No migration files found!")
              sys.exit(1)

          numbers = [extract_number(f) for f in files]
          numbers = [n for n in numbers if n is not None]
          numbers.sort()

          # Check for duplicates
          seen = set()
          duplicates = set()
          for num in numbers:
              if num in seen:
                  duplicates.add(num)
              seen.add(num)

          if duplicates:
              print(f"❌ Error: Found duplicate migration numbers: {sorted(duplicates)}")
              sys.exit(1)

          # Check for gaps
          expected_range = range(min(numbers), max(numbers) + 1)
          missing = set(expected_range) - set(numbers)

          if missing:
              print(f"❌ Error: Found gaps in migration numbers: {sorted(missing)}")
              sys.exit(1)

          print(f"✅ Success: All {len(numbers)} migration files are numbered correctly!")
          print(f"Migration number range: {min(numbers)} to {max(numbers)}")
          EOF 